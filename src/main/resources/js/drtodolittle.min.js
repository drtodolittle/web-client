!function(){"use strict";var e=angular.module("tdapp",["ngCookies","ngRoute","firebase","LocalStorageModule","xeditable"]);e.config(["$routeProvider","$locationProvider","$compileProvider","$httpProvider",function(e,o,t,n){e.when("/",{templateUrl:"main.html",controller:"MainCtrl"}).when("/register",{templateUrl:"register.html",controller:"RegCtrl"}).when("/respwd",{templateUrl:"respwd.html",controller:"respwdCtrl"}).when("/profile",{templateUrl:"profile.html",controller:"profileCtrl"}).when("/chpwd",{templateUrl:"chpwd.html",controller:"chpwdCtrl"}).when("/error",{templateUrl:"error.html"}).otherwise({redirectTo:"/error"}),t.debugInfoEnabled(!1),o.html5Mode(!0),n.interceptors.push("logininterceptor")}]),e.value("appdata",{name:"drtodolittle",nickname:"derdr",cookiename:"derdrcookie",localserver:"http://localhost:3000/api/todos",server:"https://app.drtodolittle.de/api/todos",rememberme:void 0,token:void 0,user:void 0,lip:void 0,errormsg:""}),e.controller("authdialog",["$scope","$firebaseAuth","$http","$location","$route","localStorageService","todoservice","$timeout",function(e,o,t,n,r,i,a,s){var c=o();e.resetpwd=function(){c.$sendPasswordResetEmail(e.email).then(function(){e.select_login()},function(e){"Password reset error: "+e.message})},e.register=function(){if(void 0==e.email||void 0==e.password)return void(e.errormsg="Registration-Error: Enter valid data.");var o=e.email,i=e.password,s=firebase.auth();s.createUserWithEmailAndPassword(o,i).then(function(o){var i=s.currentUser;i.sendEmailVerification().then(function(){i.getToken().then(function(o){t.defaults.headers.common.Authorization="Bearer "+o;var i={};i.topic="Welcome to Dr ToDo Little! You can use hashtags to filter tasks e.g. #new",i.done=!1,a.create(i),e.filtertag="All",e.errormsg="";var s="";s+="Registration successful! \n",s+="A verification email is waiting for you. \n",s+="But you can go on using Dr ToDo Little now \n",s+="for 24 hours without verification.",e.close_dialog(),n.path("/"),r.reload()}).catch(function(o){e.errormsg="Registration-Error: "+o.message})}).catch(function(o){e.errormsg="Registration-Error: "+o.message})}).catch(function(o){e.errormsg="Registration-Error: "+o.message})},e.loginWithGoogle=function(){var o=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(o).then(function(o){var n=firebase.auth().currentUser;e.close_dialog(),n&&n.getToken().then(function(o){t.defaults.headers.common.Authorization="Bearer "+o,e.rememberme&&i.set("logintoken",o),e.filtertag="All",e.errormsg="",r.reload()}).catch(function(e){})}).catch(function(e){})},e.login=function(){var n=o(),a=e.email,s=e.password;e.close_dialog(),n.$signInWithEmailAndPassword(a,s).then(function(o){o.getToken().then(function(o){t.defaults.headers.common.Authorization="Bearer "+o,e.rememberme&&i.set("logintoken",o),e.filtertag="All",e.errormsg="",r.reload()}).catch(function(e){})}).catch(function(e){})},e.open_dialog=function(){e.cdusermodal=!0,e.select_login()},e.select_login=function(){e.loginselected=!0,e.registerselected=!1,e.resetselected=!1},e.select_register=function(){e.loginselected=!1,e.registerselected=!0,e.resetselected=!1},e.select_reset=function(){e.loginselected=!1,e.registerselected=!1,e.resetselected=!0},e.close_dialog=function(){e.cdusermodal=!1,e.loginselected=!1,e.registerselected=!1,e.resetselected=!1},e.rememberme=!0}]),e.controller("chpwdCtrl",["$rootScope","$scope","$http","localStorageService","$route","$location",function(e,o,t,n,r,i){function a(e){var o=$("#errtemplate").clone();o.children("#errmsg").html(e),o.css("visibility","visible"),$("#nfo").append(o)}function s(e){var o=$("#successtemplate").clone();o.children("#sucmsg").html(e),o.css("visibility","visible"),$("#nfo").append(o)}var c=i.path;i.path=function(o,t){if(t===!1)var n=r.current,a=e.$on("$locationChangeSuccess",function(){r.current=n,a()});return c.apply(i,[o])},o.doChPwd=function(){if(void 0==o.oldPassword||void 0==o.newPassword)return void a("Enter valid data.");var e=firebase.auth().currentUser;firebase.auth().signInWithEmailAndPassword(e.email,o.oldPassword).then(function(e){e.updatePassword(o.newPassword).then(function(){s("Password change done!")}).catch(function(e){a(e.message)})}).catch(function(e){a(e.message)})},i.path("/",!1),$("#oldpassword").focus()}]),e.controller("MainCtrl",["$scope","$timeout","$location","todoservice",function(e,o,t,n){e.showdone=!1,e.showdonetext="Show Done",e.newtodoKeydown=function(o){var t=o.keyCode;if(13==t){if(o.preventDefault(),""!=e.newtodotxt){var r={};r.topic=e.newtodotxt,r.done=!1,e.newtodotxt="",n.create(r),e.showdone&&(e.showdone=!1,e.showdonetext="Show Done"),void 0!=r.tag?e.filtertag=r.tag:e.filtertag="All",e.todos=n.getTodosByTag(e.filtertag,e.showdone),window.scrollTo(0,0),$("#todotxta").focus()}}else 9==t&&o.preventDefault()},e.todolineKeydown=function(o,t){var r=o.keyCode;if(13==r){o.preventDefault();var i=$("#todoid"+t);i.html(i.html().replace("<br>","")),i.blur();var a=n.getTodoById(t);if(void 0!=a){a.topic=i.html(),n.update(a);var s=a.tag;if(n.checkForHashtag(a),void 0!=s){var c=n.getTodosByTag(s);c.length<=0&&n.tags.splice(n.tags.indexOf(s),1)}e.tags=n.getTags().sort(),e.todos=n.getTodosByTag(e.filtertag,e.showdone)}}},e.displaytodos=function(o){e.filtertag=o,e.todos=n.getTodosByTag(o,e.showdone)},e.seltodoline=function(e){$("#todoid"+e).focus()},e.deltodo=function(o){o.deleted=!0,n.delTodo(o),e.todos=n.getTodosByTag(e.filtertag,e.showdone)},e.togDone=function(t){n.togPreDone(t),o(function(){n.togDone(t),e.todos=n.getTodosByTag(e.filtertag,e.showdone)},1e3)},e.saveedittodo=function(o){e.showedit=!1,n.update(o)},e.togShowdone=function(){e.showdone=!e.showdone,e.showdone?e.showdonetext="Show Open":e.showdonetext="Show Done",e.todos=n.getTodosByTag(e.filtertag,e.showdone)},e.getTodosByTag=n.getTodosByTag,n.getTodos().then(function(o){e.todos=n.getTodosByTag(e.filtertag,e.showdone),e.tags=n.getTags()}),$("#todotxta").focus()}]),e.controller("navigation",["$scope","$http","localStorageService","$route","$location","$timeout",function(e,o,t,n,r,i){e.logout=function(){t.remove("logintoken"),o.defaults.headers.common.Authorization="",e.password="",n.reload()},e.changepassword=function(){r.path("/chpwd")},e.resetpassword=function(){r.path("/respwd")},e.home=function(){r.path("/"),n.reload()},e.profile=function(){r.path("/profile")}}]),e.controller("profileCtrl",["$rootScope","$scope","$http","localStorageService","$route","$location",function(e,o,t,n,r,i){function a(e){var o=$("#errtemplate").clone();o.children("#errmsg").html(e),o.css("visibility","visible"),$("#nfo").append(o)}var s=i.path;i.path=function(o,t){if(t===!1)var n=r.current,a=e.$on("$locationChangeSuccess",function(){r.current=n,a()});return s.apply(i,[o])};var c=firebase.auth().currentUser;c?o.user=c.email:a("Try again later."),i.path("/",!1)}]),e.controller("RegCtrl",["$scope","$http","$location","appdata","backend",function(e,o,t,n,r){function i(){var e=firebase.auth().currentUser.uid;void 0!=e&&firebase.database().ref("/data/reg/"+e).set({regts:firebase.database.ServerValue.TIMESTAMP,llts:0}).catch(function(e){})}e.doRegister=function(){if(void 0==e.user||void 0==e.user.email||void 0==e.user.password)return void(e.errormsg="Registration-Error: Enter valid data.");var a=e.user.email,s=e.user.password;firebase.auth().createUserWithEmailAndPassword(a,s).then(function(a){var s=firebase.auth().currentUser;s.sendEmailVerification().then(function(){s.getToken().then(function(a){n.token=a,n.user=s.email,n.lip="firebase",o.defaults.headers.common.Authorization="Basic "+a;var c={};c.topic="Welcome to Dr ToDo Little!",c.done=!1,r.postTodo(c),e.filtertag="All",e.errormsg="",n.errormsg="",i();var d="";d+="Registration successful! \n",d+="A verification email is waiting for you. \n",d+="But you can go on using Dr ToDo Little now \n",d+="for 24 hours without verification.",t.path("/main")}).catch(function(o){e.errormsg="Registration-Error: "+o.message,e.$apply()})}).catch(function(o){e.errormsg="Registration-Error: "+o.message,e.$apply()})}).catch(function(o){e.errormsg="Registration-Error: "+o.message,e.$apply()})},e.registerKeydown=function(o){var t=o.keyCode;13==t&&(o.preventDefault(),e.doRegister())},$("#liusername").focus()}]),e.controller("respwdCtrl",["$rootScope","$scope","$http","localStorageService","$route","$location",function(e,o,t,n,r,i){function a(e){var o=$("#errtemplate").clone();o.children("#errmsg").html(e),o.css("visibility","visible"),$("#nfo").append(o)}function s(e){var o=$("#successtemplate").clone();o.children("#sucmsg").html(e),o.css("visibility","visible"),$("#nfo").append(o)}var c=i.path;i.path=function(o,t){if(t===!1)var n=r.current,a=e.$on("$locationChangeSuccess",function(){r.current=n,a()});return c.apply(i,[o])},o.doResetPwd=function(){var e=firebase.auth().currentUser;if(e){var o=e.email;firebase.auth().sendPasswordResetEmail(o).then(function(){s("An email is waiting for you to reset your password.")},function(e){a("Password reset error: "+e.message)})}else a("Resetting password is not possible at this moment. Please login again.")},i.path("/",!1)}]),e.directive("authdialog",function(){return{restrict:"E",templateUrl:"templates/dialog.html",controller:["$scope","$firebaseAuth","$http","$location","$route","localStorageService","todoservice","$timeout",function(e,o,t,n,r,i,a,s){var c=o();e.resetpwd=function(){c.$sendPasswordResetEmail(e.email).then(function(){e.select_login()},function(e){"Password reset error: "+e.message})},e.register=function(){if(void 0==e.email||void 0==e.password)return void(e.errormsg="Registration-Error: Enter valid data.");var o=e.email,i=e.password,s=firebase.auth();s.createUserWithEmailAndPassword(o,i).then(function(o){var i=s.currentUser;i.sendEmailVerification().then(function(){i.getToken().then(function(o){t.defaults.headers.common.Authorization="Bearer "+o;var i={};i.topic="Welcome to Dr ToDo Little! You can use hashtags to filter tasks e.g. #new",i.done=!1,a.create(i),e.filtertag="All",e.errormsg="";var s="";s+="Registration successful! \n",s+="A verification email is waiting for you. \n",s+="But you can go on using Dr ToDo Little now \n",s+="for 24 hours without verification.",e.close_dialog(),n.path("/"),r.reload()}).catch(function(o){e.errormsg="Registration-Error: "+o.message})}).catch(function(o){e.errormsg="Registration-Error: "+o.message})}).catch(function(o){e.errormsg="Registration-Error: "+o.message})},e.loginWithGoogle=function(){var o=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(o).then(function(o){var n=firebase.auth().currentUser;e.close_dialog(),n&&n.getToken().then(function(o){t.defaults.headers.common.Authorization="Bearer "+o,e.rememberme&&i.set("logintoken",o),e.filtertag="All",e.errormsg="",r.reload()}).catch(function(e){})}).catch(function(e){})},e.login=function(){var n=o(),a=e.email,s=e.password;e.close_dialog(),n.$signInWithEmailAndPassword(a,s).then(function(o){o.getToken().then(function(o){t.defaults.headers.common.Authorization="Bearer "+o,e.rememberme&&i.set("logintoken",o),e.filtertag="All",e.errormsg="",r.reload()}).catch(function(e){})}).catch(function(e){})},e.open_dialog=function(){e.cdusermodal=!0,e.select_login()},e.select_login=function(){e.loginselected=!0,e.registerselected=!1,e.resetselected=!1},e.select_register=function(){e.loginselected=!1,e.registerselected=!0,e.resetselected=!1},e.select_reset=function(){e.loginselected=!1,e.registerselected=!1,e.resetselected=!0},e.close_dialog=function(){e.cdusermodal=!1,e.loginselected=!1,e.registerselected=!1,e.resetselected=!1},e.rememberme=!0}]}}),e.service("backend",["$http","appdata","localStorageService",function(e,o,t){var n=t.get("logintoken");void 0!=n&&(e.defaults.headers.common.Authorization="Bearer "+n),this.postTodo=function(t){e({method:"post",url:o.server,header:"application/json",data:t}).then(function(e){t.id=e.data.id},function(e){})},this.putTodo=function(t){e({method:"put",url:o.server+"/"+t.id,header:"application/json",data:t}).then(function(e){},function(e){})},this.delTodo=function(t){e({method:"delete",url:o.server+"/"+t.id,header:"application/json",data:t}).then(function(e){},function(e){})},this.doneTodo=function(t){e({method:"get",url:o.server+"/"+t.id+"/done"}).then(function(e){},function(e){})},this.undoneTodo=function(t){e({method:"get",url:o.server+"/"+t.id+"/undone"}).then(function(e){},function(e){})},this.getTodos=function(){return e({method:"get",url:o.server})},this.incTodosTotal=function(){firebase.database().ref("/data/misc/todos/total").transaction(function(e){return e+=1}).catch(function(e){})},this.incTodosDeleted=function(){firebase.database().ref("/data/misc/todos/deleted").transaction(function(e){return e+=1}).catch(function(e){})},this.incTodosDone=function(){firebase.database().ref("/data/misc/todos/done").transaction(function(e){return e+=1}).catch(function(e){})},this.incTodosUndone=function(){firebase.database().ref("/data/misc/todos/undone").transaction(function(e){return e+=1}).catch(function(e){})}}]),e.service("logininterceptor",["$q","$rootScope","$timeout","localStorageService",function(e,o,t,n){return{responseError:function(r){return 401==r.status&&(void 0!=n.get("logintoken")&&n.remove("logintoken"),o.open_dialog(),t(function(){$("#signin-email").focus()},512)),e.reject(r)}}}]),e.service("todoservice",["backend","$q",function(e,o){var t={};return t.todos=[],t.tags=[],t.create=function(o){e.postTodo(o),e.incTodosTotal(),t.addTodoObj(o)},t.update=function(o){e.putTodo(o)},t.checkForHashtag=function(e){if(void 0!=e.topic){e.tags=[];for(var o=e.topic.indexOf("#"),n=0;o>=0;){n=e.topic.indexOf(" ",o+1),n==-1&&(n=e.topic.length);var r=e.topic.substring(o,n);"#"==r&&(r=void 0),void 0!=r&&e.tags.push(r),void 0!=r&&t.tags.indexOf(r)<0&&t.tags.push(r),o=e.topic.indexOf("#",o+1)}}},t.getTags=function(){return t.tags},t.getTodos=function(){return o(function(o,n){e.getTodos().then(function(e){t.clearTodos(),e.data.forEach(function(e){t.addTodoObj(e)}),o(t.todos)})})},t.getTodosByTag=function(e,o){if(""==e||"All"==e||void 0==e){var n=[];return o?t.todos.forEach(function(e){e.done&&n.push(e)}):t.todos.forEach(function(e){e.done||n.push(e)}),n}var r=[];return t.todos.forEach(function(t){t.tags.indexOf(e)>=0&&(o?t.done&&r.push(t):t.done||r.push(t))}),r},t.setTodos=function(e){void 0!=e&&(t.todos=e,e.length>0&&t.todos.forEach(function(e){t.checkForHashtag(e)}))},t.clearTodos=function(){for(;t.todos.length>0;)t.todos.pop();for(;t.tags.length>0;)t.tags.pop()},t.getTodoById=function(e){var o=void 0;return t.todos.forEach(function(t){t.id==e&&(o=t)}),o},t.addTodoObj=function(e){return e.predone=e.done,t.checkForHashtag(e),t.todos.unshift(e),e},t.addTodo=function(e){var o={topic:e,done:!1};return t.addTodoObj(o),o},t.delTodo=function(o){e.delTodo(o),e.incTodosDeleted();var n=t.todos.indexOf(o);if(n>=0){var r=o.tag;if(t.todos.splice(n,1),void 0!=r){var i=t.getTodosByTag(r);0==i.length&&t.tags.splice(t.tags.indexOf(r),1)}}},t.togPreDone=function(e){var o=t.todos.indexOf(e);if(!(o<0)){var n=t.todos[o];n.predone?n.predone=!1:n.predone=!0}},t.togDone=function(o){o.done?(e.doneTodo(o),e.incTodosDone()):(e.undoneTodo(o),e.incTodosUndone());var n=t.todos.indexOf(o);if(!(n<0)){var r=t.todos[n];r.done?(r.done=!1,r.predone=r.done):(r.done=!0,r.predone=r.done)}},t}]);var o={apiKey:"AIzaSyCQ3iNEv4gjySzM7EFdpWQ-LOH3KRwh8fc",authDomain:"drtodolittle.firebaseapp.com",databaseURL:"https://drtodolittle.firebaseio.com",storageBucket:""};firebase.initializeApp(o)}();