!function(){"use strict";var o=angular.module("tdapp",["ngCookies","ngRoute","firebase","LocalStorageModule","xeditable"]);o.config(["$routeProvider","$locationProvider","$compileProvider","$httpProvider",function(o,e,t,n){o.when("/",{templateUrl:"main.html",controller:"MainCtrl"}).when("/register",{templateUrl:"register.html",controller:"RegCtrl"}).when("/respwd",{templateUrl:"respwd.html",controller:"respwdCtrl"}).when("/profile",{templateUrl:"profile.html",controller:"profileCtrl"}).when("/chpwd",{templateUrl:"chpwd.html",controller:"chpwdCtrl"}).when("/error",{templateUrl:"error.html"}).otherwise({redirectTo:"/error"}),t.debugInfoEnabled(!1),e.html5Mode(!0),n.interceptors.push("logininterceptor")}]),o.value("appdata",{name:"drtodolittle",nickname:"derdr",cookiename:"derdrcookie",localserver:"http://localhost:3000/api/todos",server:"https://app.drtodolittle.de/api/todos",rememberme:void 0,token:void 0,user:void 0,lip:void 0,errormsg:""}),o.controller("chpwdCtrl",["$rootScope","$scope","$http","localStorageService","$route","$location",function(o,e,t,n,r,i){function a(o){var e=$("#errtemplate").clone();e.children("#errmsg").html(o),e.css("visibility","visible"),$("#nfo").append(e)}function s(o){var e=$("#successtemplate").clone();e.children("#sucmsg").html(o),e.css("visibility","visible"),$("#nfo").append(e)}var d=i.path;i.path=function(e,t){if(t===!1)var n=r.current,a=o.$on("$locationChangeSuccess",function(){r.current=n,a()});return d.apply(i,[e])},e.doChPwd=function(){if(void 0==e.oldPassword||void 0==e.newPassword)return void a("Enter valid data.");var o=firebase.auth().currentUser;firebase.auth().signInWithEmailAndPassword(o.email,e.oldPassword).then(function(o){o.updatePassword(e.newPassword).then(function(){s("Password change done!")}).catch(function(o){a(o.message)})}).catch(function(o){a(o.message)})},i.path("/",!1),$("#oldpassword").focus()}]),o.controller("MainCtrl",["$scope","$timeout","$location","todoservice",function(o,e,t,n){o.showdone=!1,o.showdonetext="Show Done",o.newtodoKeydown=function(e){var t=e.keyCode;if(13==t){if(e.preventDefault(),""!=o.newtodotxt){var r={};r.topic=o.newtodotxt,r.done=!1,o.newtodotxt="",n.create(r),o.showdone&&(o.showdone=!1,o.showdonetext="Show Done"),void 0!=r.tag?o.filtertag=r.tag:o.filtertag="All",o.todos=n.getTodosByTag(o.filtertag,o.showdone),window.scrollTo(0,0),$("#todotxta").focus()}}else 9==t&&e.preventDefault()},o.todolineKeydown=function(e,t){var r=e.keyCode;if(13==r){e.preventDefault();var i=$("#todoid"+t);i.html(i.html().replace("<br>","")),i.blur();var a=n.getTodoById(t);if(void 0!=a){a.topic=i.html(),n.update(a);var s=a.tag;if(n.checkForHashtag(a),void 0!=s){var d=n.getTodosByTag(s);d.length<=0&&n.tags.splice(n.tags.indexOf(s),1)}o.tags=n.getTags().sort(),o.todos=n.getTodosByTag(o.filtertag,o.showdone)}}},o.displaytodos=function(e){o.filtertag=e,o.todos=n.getTodosByTag(e,o.showdone)},o.seltodoline=function(o){$("#todoid"+o).focus()},o.deltodo=function(e){e.deleted=!0,n.delTodo(e),o.todos=n.getTodosByTag(o.filtertag,o.showdone)},o.togDone=function(t){n.togPreDone(t),e(function(){n.togDone(t),o.todos=n.getTodosByTag(o.filtertag,o.showdone)},1e3)},o.saveedittodo=function(e){o.showedit=!1,n.update(e)},o.togShowdone=function(){o.showdone=!o.showdone,o.showdone?o.showdonetext="Show Open":o.showdonetext="Show Done",o.todos=n.getTodosByTag(o.filtertag,o.showdone)},o.getTodosByTag=n.getTodosByTag,n.getTodos().then(function(e){o.todos=n.getTodosByTag(o.filtertag,o.showdone),o.tags=n.getTags()}),$("#todotxta").focus()}]),o.controller("navigation",["$scope","$http","localStorageService","$route","$location","$timeout",function(o,e,t,n,r,i){o.logout=function(){t.remove("logintoken"),e.defaults.headers.common.Authorization="",o.password="",n.reload()},o.changepassword=function(){r.path("/chpwd")},o.resetpassword=function(){r.path("/respwd")},o.home=function(){r.path("/"),n.reload()},o.profile=function(){r.path("/profile")}}]),o.controller("profileCtrl",["$rootScope","$scope","$http","localStorageService","$route","$location",function(o,e,t,n,r,i){function a(o){var e=$("#errtemplate").clone();e.children("#errmsg").html(o),e.css("visibility","visible"),$("#nfo").append(e)}var s=i.path;i.path=function(e,t){if(t===!1)var n=r.current,a=o.$on("$locationChangeSuccess",function(){r.current=n,a()});return s.apply(i,[e])};var d=firebase.auth().currentUser;d?e.user=d.email:a("Try again later."),i.path("/",!1)}]),o.controller("RegCtrl",["$scope","$http","$location","appdata","backend",function(o,e,t,n,r){function i(){var o=firebase.auth().currentUser.uid;void 0!=o&&firebase.database().ref("/data/reg/"+o).set({regts:firebase.database.ServerValue.TIMESTAMP,llts:0}).catch(function(o){})}o.doRegister=function(){if(void 0==o.user||void 0==o.user.email||void 0==o.user.password)return void(o.errormsg="Registration-Error: Enter valid data.");var a=o.user.email,s=o.user.password;firebase.auth().createUserWithEmailAndPassword(a,s).then(function(a){var s=firebase.auth().currentUser;s.sendEmailVerification().then(function(){s.getToken().then(function(a){n.token=a,n.user=s.email,n.lip="firebase",e.defaults.headers.common.Authorization="Basic "+a;var d={};d.topic="Welcome to Dr ToDo Little!",d.done=!1,r.postTodo(d),o.filtertag="All",o.errormsg="",n.errormsg="",i();var c="";c+="Registration successful! \n",c+="A verification email is waiting for you. \n",c+="But you can go on using Dr ToDo Little now \n",c+="for 24 hours without verification.",t.path("/main")}).catch(function(e){o.errormsg="Registration-Error: "+e.message,o.$apply()})}).catch(function(e){o.errormsg="Registration-Error: "+e.message,o.$apply()})}).catch(function(e){o.errormsg="Registration-Error: "+e.message,o.$apply()})},o.registerKeydown=function(e){var t=e.keyCode;13==t&&(e.preventDefault(),o.doRegister())},$("#liusername").focus()}]),o.controller("respwdCtrl",["$rootScope","$scope","$http","localStorageService","$route","$location",function(o,e,t,n,r,i){function a(o){var e=$("#errtemplate").clone();e.children("#errmsg").html(o),e.css("visibility","visible"),$("#nfo").append(e)}function s(o){var e=$("#successtemplate").clone();e.children("#sucmsg").html(o),e.css("visibility","visible"),$("#nfo").append(e)}var d=i.path;i.path=function(e,t){if(t===!1)var n=r.current,a=o.$on("$locationChangeSuccess",function(){r.current=n,a()});return d.apply(i,[e])},e.doResetPwd=function(){var o=firebase.auth().currentUser;if(o){var e=o.email;firebase.auth().sendPasswordResetEmail(e).then(function(){s("An email is waiting for you to reset your password.")},function(o){a("Password reset error: "+o.message)})}else a("Resetting password is not possible at this moment. Please login again.")},i.path("/",!1)}]),o.directive("authdialog",function(){return{restrict:"E",templateUrl:"templates/dialog.html",controller:["$scope","$firebaseAuth","$http","$location","$route","localStorageService",function(o,e,t,n,r,i){var a=e();o.resetpwd=function(){a.$sendPasswordResetEmail(o.email).then(function(){o.select_login()},function(o){"Password reset error: "+o.message})},o.register=function(){if(void 0==o.email||void 0==o.password)return void(o.errormsg="Registration-Error: Enter valid data.");var e=o.email,r=o.password;a.createUserWithEmailAndPassword(e,r).then(function(e){var r=a.currentUser;r.sendEmailVerification().then(function(){r.getToken().then(function(e){t.defaults.headers.common.Authorization="Bearer "+e;var r={};r.topic="Welcome to Dr ToDo Little!",r.done=!1,backend.postTodo(r),o.filtertag="All",o.errormsg="";var i="";i+="Registration successful! \n",i+="A verification email is waiting for you. \n",i+="But you can go on using Dr ToDo Little now \n",i+="for 24 hours without verification.",n.path("/")}).catch(function(e){o.errormsg="Registration-Error: "+e.message,o.$apply()})}).catch(function(e){o.errormsg="Registration-Error: "+e.message,o.$apply()})}).catch(function(e){o.errormsg="Registration-Error: "+e.message,o.$apply()})},o.loginWithGoogle=function(){var e=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(e).then(function(e){var n=firebase.auth().currentUser;o.close_dialog(),n&&n.getToken().then(function(e){t.defaults.headers.common.Authorization="Bearer "+e,o.rememberme&&i.set("logintoken",e),o.filtertag="All",o.errormsg="",r.reload()}).catch(function(o){})}).catch(function(o){})},o.login=function(){var n=e(),a=o.email,s=o.password;o.close_dialog(),n.$signInWithEmailAndPassword(a,s).then(function(e){e.uid;e.getToken().then(function(e){t.defaults.headers.common.Authorization="Bearer "+e,o.rememberme&&i.set("logintoken",e),o.filtertag="All",o.errormsg="",r.reload()}).catch(function(o){})}).catch(function(o){})},o.open_dialog=function(){o.cdusermodal=!0,o.select_login()},o.select_login=function(){o.loginselected=!0,o.registerselected=!1,o.resetselected=!1},o.select_register=function(){o.loginselected=!1,o.registerselected=!0,o.resetselected=!1},o.select_reset=function(){o.loginselected=!1,o.registerselected=!1,o.resetselected=!0},o.close_dialog=function(){o.cdusermodal=!1,o.loginselected=!1,o.registerselected=!1,o.resetselected=!1},o.rememberme=!0}]}}),o.service("backend",["$http","appdata","localStorageService",function(o,e,t){var n=t.get("logintoken");void 0!=n&&(o.defaults.headers.common.Authorization="Bearer "+n),this.postTodo=function(t){o({method:"post",url:e.server,header:"application/json",data:t}).then(function(o){t.id=o.data.id},function(o){})},this.putTodo=function(t){o({method:"put",url:e.server+"/"+t.id,header:"application/json",data:t}).then(function(o){},function(o){})},this.delTodo=function(t){o({method:"delete",url:e.server+"/"+t.id,header:"application/json",data:t}).then(function(o){},function(o){})},this.doneTodo=function(t){o({method:"get",url:e.server+"/"+t.id+"/done"}).then(function(o){},function(o){})},this.undoneTodo=function(t){o({method:"get",url:e.server+"/"+t.id+"/undone"}).then(function(o){},function(o){})},this.getTodos=function(){return o({method:"get",url:e.server})},this.incTodosTotal=function(){firebase.database().ref("/data/misc/todos/total").transaction(function(o){return o+=1}).catch(function(o){})},this.incTodosDeleted=function(){firebase.database().ref("/data/misc/todos/deleted").transaction(function(o){return o+=1}).catch(function(o){})},this.incTodosDone=function(){firebase.database().ref("/data/misc/todos/done").transaction(function(o){return o+=1}).catch(function(o){})},this.incTodosUndone=function(){firebase.database().ref("/data/misc/todos/undone").transaction(function(o){return o+=1}).catch(function(o){})}}]),o.service("logininterceptor",["$q","$rootScope","$timeout","localStorageService",function(o,e,t,n){return{responseError:function(r){return 401==r.status&&(void 0!=n.get("logintoken")&&n.remove("logintoken"),e.open_dialog(),t(function(){$("#signin-email").focus()},512)),o.reject(r)}}}]),o.service("todoservice",["backend","$q",function(o,e){var t={};return t.todos=[],t.tags=[],t.create=function(e){o.postTodo(e),o.incTodosTotal(),t.addTodoObj(e)},t.update=function(e){o.putTodo(e)},t.checkForHashtag=function(o){if(void 0!=o.topic){o.tags=[];for(var e=o.topic.indexOf("#"),n=0;e>=0;){n=o.topic.indexOf(" ",e+1),n==-1&&(n=o.topic.length);var r=o.topic.substring(e,n);"#"==r&&(r=void 0),void 0!=r&&o.tags.push(r),void 0!=r&&t.tags.indexOf(r)<0&&t.tags.push(r),e=o.topic.indexOf("#",e+1)}}},t.getTags=function(){return t.tags},t.getTodos=function(){return e(function(e,n){o.getTodos().then(function(o){t.clearTodos(),o.data.forEach(function(o){t.addTodoObj(o)}),e(t.todos)})})},t.getTodosByTag=function(o,e){if(""==o||"All"==o||void 0==o){var n=[];return e?t.todos.forEach(function(o){o.done&&n.push(o)}):t.todos.forEach(function(o){o.done||n.push(o)}),n}var r=[];return t.todos.forEach(function(t){t.tags.indexOf(o)>=0&&(e?t.done&&r.push(t):t.done||r.push(t))}),r},t.setTodos=function(o){void 0!=o&&(t.todos=o,o.length>0&&t.todos.forEach(function(o){t.checkForHashtag(o)}))},t.clearTodos=function(){for(;t.todos.length>0;)t.todos.pop();for(;t.tags.length>0;)t.tags.pop()},t.getTodoById=function(o){var e=void 0;return t.todos.forEach(function(t){t.id==o&&(e=t)}),e},t.addTodoObj=function(o){return o.predone=o.done,t.checkForHashtag(o),t.todos.unshift(o),o},t.addTodo=function(o){var e={topic:o,done:!1};return t.addTodoObj(e),e},t.delTodo=function(e){o.delTodo(e),o.incTodosDeleted();var n=t.todos.indexOf(e);if(n>=0){var r=e.tag;if(t.todos.splice(n,1),void 0!=r){var i=t.getTodosByTag(r);0==i.length&&t.tags.splice(t.tags.indexOf(r),1)}}},t.togPreDone=function(o){var e=t.todos.indexOf(o);if(!(e<0)){var n=t.todos[e];n.predone?n.predone=!1:n.predone=!0}},t.togDone=function(e){e.done?(o.doneTodo(e),o.incTodosDone()):(o.undoneTodo(e),o.incTodosUndone());var n=t.todos.indexOf(e);if(!(n<0)){var r=t.todos[n];r.done?(r.done=!1,r.predone=r.done):(r.done=!0,r.predone=r.done)}},t}]);var e={apiKey:"AIzaSyCQ3iNEv4gjySzM7EFdpWQ-LOH3KRwh8fc",authDomain:"drtodolittle.firebaseapp.com",databaseURL:"https://drtodolittle.firebaseio.com",storageBucket:""};firebase.initializeApp(e)}();