<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Dr ToDo Little : QUnitTests</title>
	<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.22.0.css">
</head>

<body>
	<div id="qunit"></div>
	<div id="qunit-fixture"></div>
	<script src="//code.jquery.com/qunit/qunit-1.22.0.js"></script>

	<!-- Libraries -->
	<script src="js/angular.min.js"></script>
	<script src="js/angular-route.min.js"></script>
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/firebase.js"></script>
	<script src="js/angularfire.min.js"></script>
	<script src="js/angular-local-storage.min.js"></script>
	<script src="js/xeditable.min.js"></script>
	<script src="js/angular-mocks.js"></script>
	<script src="js/drtodolittle.js"></script>

	<!-- Todoservice tests -->
	<script>
		// General

		QUnit.test("todoservice", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			assert.ok(todoservice != undefined, "todoservice!=undefined")
			assert.ok(todoservice.todos.length == 0, "initial todoservice.todos.length==0")
			assert.ok(todoservice.tags.length == 0, "initial todoservice.tags.length==0")
		});

		// Unit test for functions without backend interaction

		QUnit.test("todoservice.clearTodos", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			assert.ok(todoservice.todos.length == 0, "initial todoservice.todos.length==0")
			assert.ok(todoservice.tags.length == 0, "initial todoservice.tags.length==0")
			todoservice.clearTodos()
			assert.ok(todoservice.todos.length == 0, "todoservice.clearTodos -> todoservice.todos.length==0")
			assert.ok(todoservice.tags.length == 0, "todoservice.clearTodos -> todoservice.tags.length==0")
		})

		QUnit.test("todoservice.addTodo", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			assert.ok(todoservice.todos.length == 0, "initial todoservice.todos.length==0")
			todoservice.clearTodos()
			todoservice.addTodo("derdr")
			assert.ok(todoservice.todos.length == 1, "new todo without tag -> todoservice.todos.length==1")
			assert.ok(todoservice.tags.length == 0, "new todo without tag  -> todoservice.tags.length==0")
		})

		QUnit.test("todoservice.addTodoObj", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			todoservice.clearTodos()
			var todo = {}
			todo.topic = "derdr"
			todo.done = false
			todoservice.addTodoObj(todo)
			assert.ok(todoservice.todos.length == 1, "new todo obj without tag -> todoservice.todos.length==1")
			assert.ok(todoservice.tags.length == 0, "new todo obj without tag  -> todoservice.tags.length==0")
		})

		QUnit.test("todoservice.getTodosByTag *1*", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			todoservice.clearTodos()
			assert.ok(todoservice.getTodosByTag('', false).length == 0, "todoservice.getTodosByTag('',false).length==0")
			assert.ok(todoservice.getTodosByTag('', true).length == 0, "todoservice.getTodosByTag('',true).length==0")
			assert.ok(todoservice.getTodosByTag('#derdr', false).length == 0, "todoservice.getTodosByTag('#derdr',false).length==0")
			assert.ok(todoservice.getTodosByTag('#derdr', true).length == 0, "todoservice.getTodosByTag('#derdr',true).length==0")
		})

		QUnit.test("todoservice.getTodoById", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			todoservice.clearTodos()
			assert.ok(todoservice.getTodoById('xyz') == undefined, "todoservice.getTodoById('xyz')==undefined")
			todoservice.addTodoObj({
				topic: "derdr",
				done: "false",
				id: "42"
			})
			assert.ok(todoservice.getTodoById('42') != undefined, "new todo with id 42 -> todoservice.getTodoById('42')!=undefined")
		})

		QUnit.test("todoservice.checkForHashtag", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			var todo

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr"
			todoservice.checkForHashtag(todo);
			assert.ok(todo.tags.length == 0, "todo with no tag -> todo.tags.length==0")
			assert.ok(todoservice.tags.length == 0, "todo with no tag -> todoservice.tags.length==0")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test"
			todoservice.checkForHashtag(todo);
			assert.ok(todo.tags.length == 1, "todo with tag #test -> todo.tags.length==1")
			assert.ok(todo.tags[0] == '#test', "todo with tag #test -> todo.tags[0]=='#test'")
			assert.ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr ##test"
			todoservice.checkForHashtag(todo);
			assert.ok(todo.tags.length == 1, "todo with tag ##test -> todo.tags.length==1")
			assert.ok(todo.tags[0] == '#test', "todo with tag ##test -> todo.tags[0]=='#test'")
			assert.ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr ###test"
			todoservice.checkForHashtag(todo);
			assert.ok(todo.tags.length == 1, "todo with tag ###test -> todo.tags.length==1")
			assert.ok(todo.tags[0] == '#test', "todo with tag ###test -> todo.tags[0]=='#test'")
			assert.ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test: derdr"
			todoservice.checkForHashtag(todo);
			assert.ok(todo.tags.length == 1, "todo with tag #test: -> todo.tags.length==1")
			assert.ok(todo.tags[0] == '#test', "todo with tag #test: -> todo.tags[0]=='#test'")
			assert.ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test#. derdr"
			todoservice.checkForHashtag(todo);
			assert.ok(todo.tags.length == 1, "todo with tag #test#. -> todo.tags.length==1")
			assert.ok(todo.tags[0] == '#test', "todo with tag #test#. -> todo.tags[0]=='#test'")
			assert.ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test #new derdr"
			todoservice.checkForHashtag(todo);
			assert.ok(todo.tags.length == 2, "todo with tags #test and #new -> todo.tags.length==2")
			assert.ok(todo.tags[0] == '#test', "todo with tags #test and #new -> todo.tags[0]=='#test'")
			assert.ok(todo.tags[1] == '#new', "todo with tags #test and #new -> todo.tags[1]=='#new'")
			assert.ok(todoservice.tags[0] == '#test', "todo with tags #test and #new -> todoservice.tags[0]=='#test'")
			assert.ok(todoservice.tags[1] == '#new', "todo with tags #test and #new -> todoservice.tags[1]=='#new'")
		})

		QUnit.test("todoservice.getTodosByTag *2*", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var todoservice = injector.get("todoservice")
			var todo
			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test #new derdr"
			todo.done = false
			todoservice.addTodoObj(todo)
			assert.ok(todoservice.getTodosByTag('#bla', false).length == 0, "todoservice.getTodosByTag('#bla',false).length==0")
			assert.ok(todoservice.getTodosByTag('#bla', true).length == 0, "todoservice.getTodosByTag('#bla',true).length==0")
			assert.ok(todoservice.getTodosByTag('#test', false).length == 1, "todoservice.getTodosByTag('#test',false).length==1")
			assert.ok(todoservice.getTodosByTag('#test', true).length == 0, "todoservice.getTodosByTag('#test',true).length==0")
			assert.ok(todoservice.getTodosByTag('#new', false).length == 1, "todoservice.getTodosByTag('#new',false).length==1")
			assert.ok(todoservice.getTodosByTag('#new', true).length == 0, "todoservice.getTodosByTag('#new',true).length==0")
		})

		// Unit tests for function with backend interaction (WIP)

		QUnit.test("todoservice.getTodos *1*", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var backend = injector.get("backend")

			// Mock backend-service function 'getTodos' by hand
			// Return a response object with data (a todo object)
			backend.getTodos = function() {
				return new Promise(function(resolve, reject) {
					resolve({
						statusText : "Ok",
						data : [{
							topic: 'derdr',
							done: false,
							id: 42
						}]
					})
				})
			}

			// Now test the todo-service function 'getTodos' (it's a promise)
			assert.expect(3)
			var todoservice = injector.get('todoservice')
			var thenable = new Promise(function(resolve, reject) {
				todoservice.getTodos().then(function(resp) {
					assert.ok(resp.length == 1, "todoservice.getTodos().length==1")
					assert.ok(todoservice.todos.length == 1, "todoservice.todos.length==1")
					assert.ok(todoservice.tags.length == 0, "todoservice.tags.length==0")
					resolve(resp)
				})
			})
			return thenable;
		})

		QUnit.test("todoservice.getTodos *2*", function(assert) {
			var injector = angular.injector(["ng", "tdapp"])
			var backend = injector.get("backend")

			// Mock backend-service function 'getTodos' by hand
			// Return a response object with no data (an error)
			backend.getTodos = function() {
				return new Promise(function(resolve, reject) {
					reject({
						statusText : "Error",
						data : []
					})
				})
			}

			// Now test the todo-service function 'getTodos' (it's a promise)
			assert.expect(3)
			var todoservice = injector.get('todoservice')
			var thenable = new Promise(function(resolve, reject) {
				todoservice.getTodos()
				.catch(function(error) {
					assert.ok(error.data.length == 0, "todoservice.getTodos().length==0")
					assert.ok(todoservice.todos.length == 0, "todoservice.todos.length==0")
					assert.ok(todoservice.tags.length == 0, "todoservice.tags.length==0")
					resolve()
				})
			})
			return thenable
		})

	</script>

</body>

</html>
