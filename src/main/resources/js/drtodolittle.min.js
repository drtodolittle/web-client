!function(){"use strict";var e=angular.module("tdapp",["ngCookies","ngRoute","firebase"]);e.config(["$routeProvider","$locationProvider","$compileProvider","$httpProvider",function(e,o,t,r){e.when("/",{templateUrl:"main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"login.html",controller:"AuthCtrl"}).when("/working",{templateUrl:"working.html"}).when("/register",{templateUrl:"register.html",controller:"RegCtrl"}).when("/resetpwd",{templateUrl:"resetpwd.html",controller:"ResetPwdCtrl"}).when("/settings",{templateUrl:"settings.html",controller:"SettingsCtrl"}).when("/chpwd",{templateUrl:"chpwd.html",controller:"SettingsCtrl"}).when("/egg",{templateUrl:"egg.html"}).when("/error",{templateUrl:"error.html"}).otherwise({redirectTo:"/error"}),t.debugInfoEnabled(!1),o.html5Mode(!0),r.interceptors.push("logininterceptor")}]),e.value("appdata",{name:"drtodolittle",nickname:"derdr",cookiename:"derdrcookie",localserver:"http://localhost:3000/api/todos",server:"https://app.drtodolittle.de/api/todos",rememberme:void 0,token:void 0,user:void 0,lip:void 0,errormsg:""}),e.controller("AuthCtrl",["$scope","$http","$cookies","$location","$timeout","appdata","autologinservice",function(e,o,t,r,n,i,a){function s(){i.errormsg="",n(function(){r.path("/")},1e3)}a.setScope(e),e.goResetPwd=function(){i.errormsg="",r.path("/resetpwd")},e.doRememberMe=function(){var e=$("#rememberme").prop("checked");e?($("#rememberme").prop("checked",!1),i.rememberme=!1):($("#rememberme").prop("checked",!0),i.rememberme=!0)},e.doLogin=function(){if($("#libut").blur(),e.errormsg="",i.rememberme=$("#rememberme").prop("checked"),void 0==e.email||void 0==e.password)return void(e.errormsg="Login-Error: Enter a valid E-Mail-Adress and a valid password!");var n=e.email;i.tmpuser=n;var d=e.password;r.path("/working"),i.lip="firebase",firebase.auth().signInWithEmailAndPassword(n,d).then(function(r){var n=r.uid;i.user=r.email;var d=function(){r.getToken().then(function(r){if(i.rememberme){var n=new Date,a=new Date(n.getFullYear(),n.getMonth()+1,n.getDate()),d={token:r,user:i.user,lip:i.lip};t.put(i.cookiename,JSON.stringify(d),{expires:a})}i.token=r,o.defaults.headers.common.Authorization="Bearer "+r,e.filtertag="All",e.errormsg="",i.errormsg="",s()}).catch(function(e){i.errormsg="Login-Error: "+e.message,a.doLogout()})};r.emailVerified?d():firebase.database().ref("/data/reg/"+n).once("value").then(function(e){if(null==e||void 0==e)throw{message:"Invalid userdata on server."};var o={};o["/data/reg/"+n]={regts:e.val().regts,llts:firebase.database.ServerValue.TIMESTAMP},firebase.database().ref().update(o).then(function(){firebase.database().ref("/data/reg/"+n).once("value").then(function(e){var o=e.val().regts,t=e.val().llts;o+864e5<t?(i.errormsg="Login-Error: You now have to verify your email to use Dr ToDo Little.",a.doLogout()):d()}).catch(function(e){i.errormsg="Login-Error: "+e.message,a.doLogout()})}).catch(function(e){i.errormsg="Login-Error: "+e.message,a.doLogout()})}).catch(function(e){i.errormsg="Login-Error: "+e.message,a.doLogout()})}).catch(function(e){i.errormsg="Login-Error: "+e.message,a.doLogout()})},e.doLoginWithGoogle=function(){$("#libutgoogle").blur(),i.lip="google";var n=new firebase.auth.GoogleAuthProvider;r.path("/working"),firebase.auth().signInWithPopup(n).then(function(r){i.user=r.user.email,i.lip="google";var n=firebase.auth().currentUser;n?n.getToken().then(function(r){if(i.rememberme){var n=new Date,a=new Date(n.getFullYear(),n.getMonth()+1,n.getDate()),d={token:r,user:i.user,lip:i.lip};t.put(i.cookiename,JSON.stringify(d),{expires:a})}i.token=r,o.defaults.headers.common.Authorization="Bearer "+r,e.filtertag="All",e.errormsg="",i.errormsg="",s()}).catch(function(e){i.errormsg="Login-Error: "+e.message,a.doLogout()}):(i.errormsg="Login-Error: Not logged in.",a.doLogout())}).catch(function(e){i.errormsg="Login-Error: "+e.message,a.doLogout()})},e.loginKeydown=function(o){var t=o.keyCode;13==t&&(o.preventDefault(),e.doLogin())},e.goRegister=function(){i.errormsg="",$("#libutreg").blur(),r.path("/register")},e.errormsg=i.errormsg,e.email=i.tmpuser,a.check(),$("#liuser").focus()}]),e.controller("MainCtrl",["$scope","$timeout","$interval","$http","$cookies","$location","$routeParams","appdata","todoservice","backend","autologinservice",function(e,o,t,r,n,i,a,s,d,c,u){u.setScope(e),c.setScope(e),e.showdone=!1,e.showdonetext="Show Done",e.goSettings=function(){i.path("/settings")},e.tmpcustommenu=0,e.showcustommenu=function(){0==e.tmpcustommenu?(e.tmpcustommenu=1,$("#customnavbaricon").attr("src","images/arrow-left-3x.png"),navigator.userAgent.match(/(iPod|iPhone|iPad|Android)/)?($("body").scrollTop(0),$(".custommenu").animate({height:"126px"},500)):$("html").scrollTop()>64?$("html").animate({scrollTop:0},500,function(){$(".custommenu").animate({height:"126px"},500)}):($("html").scrollTop(0),$(".custommenu").animate({height:"126px"},500))):(e.tmpcustommenu=0,$("#customnavbaricon").attr("src","images/menu-3x.png"),$(".custommenu").animate({height:"0px"},500),$("#todotxta").focus())},e.doLogout=function(){i.path("/working"),o(function(){u.doLogout()},1e3)},e.newtodoKeydown=function(o){var t=o.keyCode;if(13==t){if(o.preventDefault(),""!=e.newtodotxt){var r={};r.topic=e.newtodotxt,r.done=!1,e.newtodotxt="",c.postTodo(r),c.incTodosTotal(),d.addTodoObj(r),e.showdone&&(e.showdone=!1,e.showdonetext="Show Done"),void 0!=r.tag?e.filtertag=r.tag:e.filtertag="All",e.todos=d.getTodosByTag(e.filtertag,e.showdone),window.scrollTo(0,0),$("#todotxta").focus()}}else 9==t&&o.preventDefault()},e.todolineKeydown=function(o,t){var r=o.keyCode;if(13==r){o.preventDefault();var n=$("#todoid"+t);n.html(n.html().replace("<br>","")),n.blur();var i=d.getTodoById(t);if(void 0!=i){i.topic=n.html(),c.putTodo(i);var a=i.tag;if(d.checkForHashtag(i),void 0!=a){var s=d.getTodosByTag(a);s.length<=0&&d.tags.splice(d.tags.indexOf(a),1)}e.tags=d.getTags().sort(),e.todos=d.getTodosByTag(e.filtertag,e.showdone)}}},e.seltodoline=function(e){$("#todoid"+e).focus()},e.deltodo=function(o){o.deleted=!0,c.delTodo(o),c.incTodosDeleted(),d.delTodo(o),e.todos=d.getTodosByTag(e.filtertag,e.showdone)},e.togDone=function(t){d.togPreDone(t),o(function(){d.togDone(t),t.done?(c.doneTodo(t),c.incTodosDone()):(c.undoneTodo(t),c.incTodosUndone()),e.todos=d.getTodosByTag(e.filtertag,e.showdone)},1e3)},e.togShowdone=function(){e.showdone=!e.showdone,e.showdone?e.showdonetext="Show Open":e.showdonetext="Show Done",e.todos=d.getTodosByTag(e.filtertag,e.showdone)},e.getTodosByTag=d.getTodosByTag,u.check(),$("#todotxta").focus()}]),e.controller("RegCtrl",["$scope","$http","$location","appdata","backend",function(e,o,t,r,n){function i(){var e=firebase.auth().currentUser.uid;void 0!=e&&firebase.database().ref("/data/reg/"+e).set({regts:firebase.database.ServerValue.TIMESTAMP,llts:0}).catch(function(e){})}e.goLogin=function(){t.path("/login")},e.doRegister=function(){if(void 0==e.user||void 0==e.user.email||void 0==e.user.password)return void(e.errormsg="Registration-Error: Enter valid data.");var a=e.user.email,s=e.user.password;firebase.auth().createUserWithEmailAndPassword(a,s).then(function(a){var s=firebase.auth().currentUser;s.sendEmailVerification().then(function(){s.getToken().then(function(a){r.token=a,r.user=s.email,r.lip="firebase",o.defaults.headers.common.Authorization="Basic "+a;var d={};d.topic="Welcome to Dr ToDo Little!",d.done=!1,n.postTodo(d),e.filtertag="All",e.errormsg="",r.errormsg="",i();var c="";c+="Registration successful! \n",c+="A verification email is waiting for you. \n",c+="But you can go on using Dr ToDo Little now \n",c+="for 24 hours without verification.",t.path("/main")}).catch(function(o){e.errormsg="Registration-Error: "+o.message,e.$apply()})}).catch(function(o){e.errormsg="Registration-Error: "+o.message,e.$apply()})}).catch(function(o){e.errormsg="Registration-Error: "+o.message,e.$apply()})},e.registerKeydown=function(o){var t=o.keyCode;13==t&&(o.preventDefault(),e.doRegister())},$("#liusername").focus()}]),e.controller("ResetPwdCtrl",["$scope","$location","appdata","autologinservice",function(e,o,t,r){e.goLogin=function(){o.path("/login")},e.doResetPwd=function(){if($("#rb").blur(),e.errormsg="",t.errormsg="",void 0==e.email)return void(e.errormsg="Error: Enter valid data.");var n=e.email;o.path("/#/working"),firebase.auth().sendPasswordResetEmail(n).then(function(){t.errormsg="",r.doLogout()},function(e){var r="Password reset error: "+e.message;t.errormsg=r,o.path("/resetpwd")})},e.doResetPwdKeydown=function(o){var t=o.keyCode;13==t&&(o.preventDefault(),e.doResetPwd())},$("#liuser").focus(),e.errormsg=t.errormsg,e.email=t.tmpuser}]),e.controller("SettingsCtrl",["$scope","$http","$location","$cookies","$timeout","appdata","autologinservice",function(e,o,t,r,n,i,a){if(e.goMain=function(){t.path("/")},e.goSettings=function(){t.path("/settings")},e.goChPwd=function(){t.path("/chpwd")},e.doChPwd=function(){e.errormsg="";var o=firebase.auth().currentUser;return o||a.doLogout(),void 0==e.oldPassword||void 0==e.newPassword?void(e.errormsg="Error: Enter valid data."):(t.path("/working"),void firebase.auth().signInWithEmailAndPassword(o.email,e.oldPassword).then(function(o){o.updatePassword(e.newPassword).then(function(){t.path("/#/settings")}).catch(function(e){var o="Error: "+e.message;$appdata.errormsg=o,a.doLogout()})}).catch(function(e){var o="Error: "+e.message;$appdata.errormsg=o,a.doLogout()}))},e.doResetPwd=function(){var e=firebase.auth().currentUser;if(e){t.path("/working");var o=e.email;firebase.auth().sendPasswordResetEmail(o).then(function(){a.doLogout()},function(e){a.doLogout()})}else i.errormsg="An error has occured. Login again!",a.doLogout()},void 0==i.user&&void 0==i.token){var s=r.get(i.derdrcookie);if(void 0==s)a.doLogout();else{var d=JSON.parse(s);i.user=d.user,i.token=d.token,i.lip=d.lip}}e.user=i.user,e.lip=i.lip,$("#oldpassword").focus()}]),e.directive("authdialog",function(){return{restrict:"E",templateUrl:"templates/dialog.html",controller:["$scope","$firebaseAuth","autologinservice","$http","appdata","$location",function(e,o,t,r,n,i){e.doLogin=function(){var a=o(),s=e.email;n.tmpuser=s;var d=e.password;e.close_dialog(),n.lip="firebase",a.$signInWithEmailAndPassword(s,d).then(function(o){o.uid;n.user=o.email,o.getToken().then(function(o){n.token=o,r.defaults.headers.common.Authorization="Bearer "+o,e.filtertag="All",e.errormsg="",n.errormsg="",i.path("/")}).catch(function(e){n.errormsg="Login-Error: "+e.message,t.doLogout()})}).catch(function(e){n.errormsg="Login-Error: "+e.message,t.doLogout()})},e.open_dialog=function(){e.cdusermodal=!0,e.select_login()},e.select_login=function(){e.loginselected=!0,e.registerselected=!1,e.resetselected=!1},e.select_register=function(){e.loginselected=!1,e.registerselected=!0,e.resetselected=!1},e.select_reset=function(){e.loginselected=!1,e.registerselected=!1,e.resetselected=!0},e.close_dialog=function(){e.cdusermodal=!1,e.loginselected=!1,e.registerselected=!1,e.resetselected=!1}}]}}),e.service("autologinservice",["$http","$location","$cookies","$timeout","$compile","$routeParams","appdata","todoservice","backend",function(e,o,t,r,n,i,a,s,d){var c;this.setScope=function(e){c=e},this.getAllTodos=function(){c.filtertag="All",d.getTodos(function(){if(c.tags=s.getTags().sort(),c.todos=s.getTodosByTag(c.filtertag,c.showdone),void 0!=i.type&&void 0!=i.id&&"todo"==i.type){var e=s.getTodoById(i.id);if(void 0!=e){var t=[];t.push(e),c.todos=t}else c.todos=[]}void 0!=i.type&&void 0!=i.id&&"tag"==i.type&&(c.todos=s.getTodosByTag("#"+i.id,!1)),void 0==i.type&&void 0==i.id&&void 0==i.type&&o.path("/"),"undefined"==typeof window.orientation&&$("#todotxta").blur().focus()})},this.doLogout=function(){t.remove(a.cookiename),s.clearTodos(),a.user=void 0,a.lip=void 0,a.token=void 0,a.rememberme=void 0,o.path("/login"),firebase.auth().signOut().catch(function(e){}),r(function(){$("#liuser").focus()},128)},this.check=function(){if(void 0==a.user&&void 0==a.token&&void 0==a.lip){var r=t.get(a.cookiename);if(void 0!=r){c.errormsg="";var n=JSON.parse(r);a.token=n.token,a.user=n.user,a.lip=n.lip,e.defaults.headers.common.Authorization="Bearer "+a.token,this.getAllTodos()}else o.path("/login")}else e.defaults.headers.common.Authorization="Bearer "+a.token,this.getAllTodos()}}]),e.service("backend",["$http","$timeout","$location","appdata","todoservice",function(e,o,t,r,n){var i;this.setScope=function(e){i=e},this.postTodo=function(o){e({method:"post",url:r.server,header:"application/json",data:o}).then(function(e){o.id=e.data.id},function(e){})},this.putTodo=function(o){e({method:"put",url:r.server+"/"+o.id,header:"application/json",data:o}).then(function(e){},function(e){})},this.delTodo=function(o){e({method:"delete",url:r.server+"/"+o.id,header:"application/json",data:o}).then(function(e){},function(e){})},this.doneTodo=function(o){e({method:"get",url:r.server+"/"+o.id+"/done"}).then(function(e){},function(e){})},this.undoneTodo=function(o){e({method:"get",url:r.server+"/"+o.id+"/undone"}).then(function(e){},function(e){})},this.getTodos=function(o){e({method:"get",url:r.server}).then(function(e){n.clearTodos(),e.data.forEach(function(e){n.addTodoObj(e)}),o()},function(e){i.errormsg="Server not available!"})},this.incTodosTotal=function(){firebase.database().ref("/data/misc/todos/total").transaction(function(e){return e+=1}).catch(function(e){})},this.incTodosDeleted=function(){firebase.database().ref("/data/misc/todos/deleted").transaction(function(e){return e+=1}).catch(function(e){})},this.incTodosDone=function(){firebase.database().ref("/data/misc/todos/done").transaction(function(e){return e+=1}).catch(function(e){})},this.incTodosUndone=function(){firebase.database().ref("/data/misc/todos/undone").transaction(function(e){return e+=1}).catch(function(e){})}}]),e.service("logininterceptor",["$q","$location","$scope",function(e,o,t){return{responseError:function(o){return 401==o.status&&t.open_dialog(),e.reject(o)}}}]),e.service("routeengine",["$location","$route",function(e,o){e.path();return{request:function(e){return e},requestError:function(e){return canRecover(e)?responseOrNewPromise:$q.reject(e)}}}]),e.service("todoservice",function(){var e={};return e.todos=[],e.tags=[],e.checkForHashtag=function(o){if(void 0!=o.topic){o.tags=[];for(var t=o.topic.indexOf("#"),r=0;t>=0;){r=o.topic.indexOf(" ",t+1),r==-1&&(r=o.topic.length);var n=o.topic.substring(t,r);"#"==n&&(n=void 0),void 0!=n&&o.tags.push(n),void 0!=n&&e.tags.indexOf(n)<0&&e.tags.push(n),t=o.topic.indexOf("#",t+1)}}},e.getTags=function(){return e.tags},e.getTodos=function(){return e.todos},e.getTodosByTag=function(o,t){if(""==o||"All"==o){var r=[];return t?e.todos.forEach(function(e){e.done&&r.push(e)}):e.todos.forEach(function(e){e.done||r.push(e)}),r}var n=[];return e.todos.forEach(function(e){e.tags.indexOf(o)>=0&&(t?e.done&&n.push(e):e.done||n.push(e))}),n},e.setTodos=function(o){void 0!=o&&(e.todos=o,o.length>0&&e.todos.forEach(function(o){e.checkForHashtag(o)}))},e.clearTodos=function(){for(;e.todos.length>0;)e.todos.pop();for(;e.tags.length>0;)e.tags.pop()},e.getTodoById=function(o){var t=void 0;return e.todos.forEach(function(e){e.id==o&&(t=e)}),t},e.addTodoObj=function(o){return o.predone=o.done,e.checkForHashtag(o),e.todos.unshift(o),o},e.addTodo=function(o){var t={topic:o,done:!1};return e.addTodoObj(t),t},e.delTodo=function(o){var t=e.todos.indexOf(o);if(t>=0){var r=o.tag;if(e.todos.splice(t,1),void 0!=r){var n=e.getTodosByTag(r);0==n.length&&e.tags.splice(e.tags.indexOf(r),1)}}},e.togPreDone=function(o){var t=e.todos.indexOf(o);if(!(t<0)){var r=e.todos[t];r.predone?r.predone=!1:r.predone=!0}},e.togDone=function(o){var t=e.todos.indexOf(o);if(!(t<0)){var r=e.todos[t];r.done?(r.done=!1,r.predone=r.done):(r.done=!0,r.predone=r.done)}},e});var o={apiKey:"AIzaSyCQ3iNEv4gjySzM7EFdpWQ-LOH3KRwh8fc",authDomain:"drtodolittle.firebaseapp.com",databaseURL:"https://drtodolittle.firebaseio.com",storageBucket:""};firebase.initializeApp(o)}();