<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Dr ToDo Little : QUnitTests</title>
	<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.22.0.css">
</head>

<body>
	<!-- QUnit -->
	<div id="qunit"></div>
	<div id="qunit-fixture"></div>
	<script src="//code.jquery.com/qunit/qunit-1.22.0.js"></script>

	<!-- Libraries -->
	<script src="js/angular.min.js"></script>
	<script src="js/angular-route.min.js"></script>
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/firebase.js"></script>
	<script src="js/angularfire.min.js"></script>
	<script src="js/angular-local-storage.min.js"></script>
	<script src="js/xeditable.min.js"></script>
	<script src="js/drtodolittle.js"></script>

	<!-- External -->
	<script src="https://code.angularjs.org/1.5.8/angular-mocks.js"></script>

	<!-- Tests -->
	<script>

        var injector
        var backend
        var todoservice

        module("todoservice", {
            setup: function() {
                angular.module('tdapp');
                injector = angular.injector(['ngMock','ng','tdapp']);
                todoservice = injector.get('todoservice');
                backend = injector.get('backend');
            },
            teardown: function() {
            }
        });

        // General

        test("init", function() {
            ok(todoservice != undefined, "todoservice != undefined")
            ok(backend != undefined, "backend != undefined")
            ok(todoservice.todos.length == 0, "initial todoservice.todos.length==0")
            ok(todoservice.tags.length == 0, "initial todoservice.tags.length==0")
        });

        // Tests for functions without backend interaction

        test("clearTodos", function() {
			ok(todoservice.todos.length == 0, "initial todoservice.todos.length==0")
			ok(todoservice.tags.length == 0, "initial todoservice.tags.length==0")
			todoservice.clearTodos()
			ok(todoservice.todos.length == 0, "todoservice.clearTodos -> todoservice.todos.length==0")
			ok(todoservice.tags.length == 0, "todoservice.clearTodos -> todoservice.tags.length==0")
		})

        test("addTodo", function() {
			ok(todoservice.todos.length == 0, "initial todoservice.todos.length==0")
			todoservice.clearTodos()
			todoservice.addTodo("derdr")
			ok(todoservice.todos.length == 1, "new todo without tag -> todoservice.todos.length==1")
			ok(todoservice.tags.length == 0, "new todo without tag  -> todoservice.tags.length==0")
		})

        test("addTodoObj", function() {
			todoservice.clearTodos()
			var todo = {}
			todo.topic = "derdr"
			todo.done = false
			todoservice.addTodoObj(todo)
			ok(todoservice.todos.length == 1, "new todo obj without tag -> todoservice.todos.length==1")
			ok(todoservice.tags.length == 0, "new todo obj without tag  -> todoservice.tags.length==0")
		})

        test("getTodosByTag *1*", function() {
			todoservice.clearTodos()
			ok(todoservice.getTodosByTag('', false).length == 0, "todoservice.getTodosByTag('',false).length==0")
			ok(todoservice.getTodosByTag('', true).length == 0, "todoservice.getTodosByTag('',true).length==0")
			ok(todoservice.getTodosByTag('#derdr', false).length == 0, "todoservice.getTodosByTag('#derdr',false).length==0")
			ok(todoservice.getTodosByTag('#derdr', true).length == 0, "todoservice.getTodosByTag('#derdr',true).length==0")
		})

        test("getTodoById", function() {
			todoservice.clearTodos()
			ok(todoservice.getTodoById('xyz') == undefined, "todoservice.getTodoById('xyz')==undefined")
			todoservice.addTodoObj({
				topic: "derdr",
				done: "false",
				id: "42"
			})
			ok(todoservice.getTodoById('42') != undefined, "new todo with id 42 -> todoservice.getTodoById('42')!=undefined")
		})

        test("checkForHashtag", function() {
			var todo

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr"
			todoservice.checkForHashtag(todo);
			ok(todo.tags.length == 0, "todo with no tag -> todo.tags.length==0")
			ok(todoservice.tags.length == 0, "todo with no tag -> todoservice.tags.length==0")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test"
			todoservice.checkForHashtag(todo);
			ok(todo.tags.length == 1, "todo with tag #test -> todo.tags.length==1")
			ok(todo.tags[0] == '#test', "todo with tag #test -> todo.tags[0]=='#test'")
			ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr ##test"
			todoservice.checkForHashtag(todo);
			ok(todo.tags.length == 1, "todo with tag ##test -> todo.tags.length==1")
			ok(todo.tags[0] == '#test', "todo with tag ##test -> todo.tags[0]=='#test'")
			ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr ###test"
			todoservice.checkForHashtag(todo);
			ok(todo.tags.length == 1, "todo with tag ###test -> todo.tags.length==1")
			ok(todo.tags[0] == '#test', "todo with tag ###test -> todo.tags[0]=='#test'")
			ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test: derdr"
			todoservice.checkForHashtag(todo);
			ok(todo.tags.length == 1, "todo with tag #test: -> todo.tags.length==1")
			ok(todo.tags[0] == '#test', "todo with tag #test: -> todo.tags[0]=='#test'")
			ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test#. derdr"
			todoservice.checkForHashtag(todo);
			ok(todo.tags.length == 1, "todo with tag #test#. -> todo.tags.length==1")
			ok(todo.tags[0] == '#test', "todo with tag #test#. -> todo.tags[0]=='#test'")
			ok(todoservice.tags[0] == '#test', "todo with tag #test: -> todoservice.tags[0]=='#test'")

			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test #new derdr"
			todoservice.checkForHashtag(todo);
			ok(todo.tags.length == 2, "todo with tags #test and #new -> todo.tags.length==2")
			ok(todo.tags[0] == '#test', "todo with tags #test and #new -> todo.tags[0]=='#test'")
			ok(todo.tags[1] == '#new', "todo with tags #test and #new -> todo.tags[1]=='#new'")
			ok(todoservice.tags[0] == '#test', "todo with tags #test and #new -> todoservice.tags[0]=='#test'")
			ok(todoservice.tags[1] == '#new', "todo with tags #test and #new -> todoservice.tags[1]=='#new'")
		})

        test("getTodosByTag *2*", function() {
			var todo
			todoservice.clearTodos()
			todo = {}
			todo.topic = "derdr #test #new derdr"
			todo.done = false
			todoservice.addTodoObj(todo)
			ok(todoservice.getTodosByTag('#bla', false).length == 0, "todoservice.getTodosByTag('#bla',false).length==0")
			ok(todoservice.getTodosByTag('#bla', true).length == 0, "todoservice.getTodosByTag('#bla',true).length==0")
			ok(todoservice.getTodosByTag('#test', false).length == 1, "todoservice.getTodosByTag('#test',false).length==1")
			ok(todoservice.getTodosByTag('#test', true).length == 0, "todoservice.getTodosByTag('#test',true).length==0")
			ok(todoservice.getTodosByTag('#new', false).length == 1, "todoservice.getTodosByTag('#new',false).length==1")
			ok(todoservice.getTodosByTag('#new', true).length == 0, "todoservice.getTodosByTag('#new',true).length==0")
		})

        // Unit tests for function with backend interaction

        test("getTodos *1*", function() {
			// Mock backend-service function 'getTodos' by hand
			// Return a response object with data (a todo object)
			backend.getTodos = function() {
				return new Promise(function(resolve, reject) {
					resolve({
						statusText: "Ok",
						data: [{
							topic: 'derdr',
							done: false,
							id: 42
						}]
					})
				})
			}
			// Now test the todo-service function 'getTodos' (it's a promise)
			expect(3)
			return todoservice.getTodos().then(function(resp) {
				ok(resp.length == 1, "todoservice.getTodos().length==1")
				ok(todoservice.todos.length == 1, "todoservice.todos.length==1")
				ok(todoservice.tags.length == 0, "todoservice.tags.length==0")
			})
		})

        test("getTodos *2*", function() {
			// Mock backend-service function 'getTodos' by hand
			// Return a response object with no data (an error)
			backend.getTodos = function() {
				return new Promise(function(resolve, reject) {
					reject({
						statusText: "Error",
						data: []
					})
				})
			}
			// Now test the todo-service function 'getTodos' (it's a promise)
			expect(3)
			return todoservice.getTodos().catch(function(error) {
				ok(error.data.length == 0, "todoservice.getTodos().length==0")
				ok(todoservice.todos.length == 0, "todoservice.todos.length==0")
				ok(todoservice.tags.length == 0, "todoservice.tags.length==0")
			})
		})

        test("create *1*", function() {
			// Create unique id
			var _id = Date.now()
			// Mock backend-service function 'postTodo' by hand
			backend.postTodo = function(newtodo) {
				return new Promise(function(resolve, reject) {
					newtodo.id = _id
					resolve({
						statusText: "Ok",
						data: newtodo
					})
				})
			}
			// Now test the todo-service function 'create' (it's a promise)
			expect(4)
			var newtodo = {
				topic: "test",
				done: false,
				id: 0
			}
			return todoservice.create(newtodo).then(function() {
				ok(todoservice.todos.length == 1, "todoservice.todos.length==1")
				ok(todoservice.todos[0].id != 0, "todoservice.todos[0].id!=0")
				ok(todoservice.todos[0].id == _id, "todoservice.todos[0].id==" + _id)
				ok(todoservice.todos[0].topic == 'test', "todoservice.todos[0].topic=='test'")
			})
		})

        test("create *2*", function() {
			// Mock backend-service function 'postTodo' by hand
			// Return a response object with no data (an error)
			backend.postTodo = function(newtodo) {
				return new Promise(function(resolve, reject) {
					reject({
						statusText: "Error",
						data: []
					})
				})
			}
			// Now test the todo-service function 'create' (it's a promise)
			// and expect a rejection
			expect(1)
			var newtodo = {
				topic: "test",
				done: false,
				id: 0
			}
			return todoservice.create(newtodo).catch(function() {
				ok(todoservice.todos.length == 0, "todoservice.todos.length==0")
			})
		})

        test("done *1*", function() {
			// Mock backend-service function 'doneTodo' by hand
			// Return a response object with no data (only ok status)
			backend.doneTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					todo.done = true
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'done' (it's a promise)
			expect(2)
			var newtodo = {
				topic: "test",
				done: false,
				id: 42
			}
			return todoservice.done(newtodo).then(function() {
				ok(newtodo.done, "newtodo.done == true")
				ok(todoservice.todos.length == 0, "todoservice.todos.length == 0")
			})
		})

        test("done *2*", function() {
			// Mock backend-service function 'doneTodo' by hand
			// Return a response object with no data (only ok status)
			backend.doneTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					todo.done = true
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'done' (it's a promise)
			expect(3)
			var newtodo = {
				topic: "test",
				done: false,
				id: 42
			}
			todoservice.addTodoObj(newtodo)
			return todoservice.done(newtodo).then(function() {
				ok(newtodo.done, "newtodo.done == true")
				ok(todoservice.todos.length == 1, "todoservice.todos.length == 1")
				ok(todoservice.todos[0].done, "todoservice.todos[0].done == true")
			})
		})

        test("done *3*", function() {
			// Mock backend-service function 'doneTodo' by hand
			// Return a rejection
			backend.doneTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					reject()
				})
			}
			// Now test the todo-service function 'done' (it's a promise)
			expect(2)
			var newtodo = {
				topic: "test",
				done: false,
				id: 42
			}
			return todoservice.done(newtodo).catch(function(resp) {
				ok(newtodo.done == false, "newtodo.done == false (no change)")
				ok(resp.message != undefined, "response.message != undefined")
			})
		})

        test("undone *1*", function() {
			// Mock backend-service function 'undoneTodo' by hand
			// Return a response object with no data (only ok status)
			backend.undoneTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					todo.done = false
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'undone' (it's a promise)
			expect(2)
			var newtodo = {
				topic: "test",
				done: true,
				id: 77
			}
			return todoservice.undone(newtodo).then(function() {
				ok(!newtodo.done, "newtodo.done == false")
				ok(todoservice.todos.length == 0, "todoservice.todos.length == 0")
			})
		})

        test("undone *2*", function() {
			// Mock backend-service function 'undoneTodo' by hand
			// Return a response object with no data (only ok status)
			backend.undoneTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					todo.done = false
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'undone' (it's a promise)
			expect(3)
			var newtodo = {
				topic: "test",
				done: true,
				id: 42
			}
			todoservice.addTodoObj(newtodo)
			return todoservice.undone(newtodo).then(function() {
				ok(!newtodo.done, "newtodo.done == false")
				ok(todoservice.todos.length == 1, "todoservice.todos.length == 1")
				ok(!todoservice.todos[0].done, "todoservice.todos[0].done == false")
			})
		})

        test("undone *3*", function() {
			// Mock backend-service function 'undoneTodo' by hand
			// Return a rejection
			backend.undoneTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					reject()
				})
			}
			// Now test the todo-service function 'undone' (it's a promise)
			expect(2)
			var newtodo = {
				topic: "test",
				done: true,
				id: 42
			}
			return todoservice.undone(newtodo).catch(function(resp) {
				ok(newtodo.done, "newtodo.done == true (no change)")
				ok(resp.message != undefined, "response.message != undefined")
			})
		})

        test("update *1*", function() {
			// Mock backend-service function 'putTodo' by hand
			// Return a response object with no data (only ok status)
			backend.putTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'update' (it's a promise)
			expect(3)
			var newtodo = {
				topic: "blablabla",
				done: false,
				id: 123
			}
			todoservice.addTodoObj(newtodo)
			newtodo.topic = "tataaa #newtag"
			return	todoservice.update(newtodo).then(function() {
				ok(todoservice.todos.length == 1, "todoservice.todos.length == 1")
				ok(todoservice.todos[0].topic == 'tataaa #newtag', "newtodo.topic == 'tataaa #newtag'")
				ok(todoservice.tags[0] == '#newtag',"todoservice.tags[0] == '#newtag'")
			})
		})

        test("update *2*", function() {
			// Mock backend-service function 'putTodo' by hand
			// Return a rejection
			backend.putTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					reject()
				})
			}
			// Now test the todo-service function 'update' (it's a promise)
			expect(3)
			var newtodo = {
				topic: "tataaa",
				done: false,
				id: 777
			}
			todoservice.addTodoObj(newtodo)
			newtodo.topic = 'hahaha! #newtag'
			return todoservice.update(newtodo).catch(function(resp) {
				ok(resp.message != undefined, "response.message != undefined")
				ok(todoservice.todos.length == 1,"todoservice.todos.length == 1")
				ok(todoservice.tags.length == 0,"todoservice.tags.length == 0 (no change)")
			})
		})

        test("delTodo *1*", function() {
			// Mock backend-service function 'delTodo' by hand
			// Return a response object with no data (only ok status)
			backend.delTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'delTodo' (it's a promise)
			expect(3)
			var newtodo1 = {
				topic: "todo1",
				done: false,
				id: 1
			}
			todoservice.addTodoObj(newtodo1)
			var newtodo2 = {
				topic: "todo2",
				done: false,
				id: 2
			}
			todoservice.addTodoObj(newtodo2)
			return todoservice.delTodo(newtodo2).then(function() {
				ok(todoservice.todos.length == 1, "todoservice.todos.length == 1")
				ok(todoservice.todos[0].topic == 'todo1', "todoservice.todos[0].topic == 'todo1'")
				ok(todoservice.tags.length == 0,"todoservice.tags.length == 0")
			})
		})

        test("delTodo *2*", function() {
			// Mock backend-service function 'delTodo' by hand
			// Return a response object with no data (only ok status)
			backend.delTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'delTodo' (it's a promise)
			expect(3)
			var newtodo1 = {
				topic: "todo1",
				done: false,
				id: 1
			}
			todoservice.addTodoObj(newtodo1)
			var newtodo2 = {
				topic: "todo2 #new",
				done: false,
				id: 2
			}
			todoservice.addTodoObj(newtodo2)
			return todoservice.delTodo(newtodo2).then(function() {
				ok(todoservice.todos.length == 1, "todoservice.todos.length == 1")
				ok(todoservice.todos[0].topic == 'todo1', "todoservice.todos[0].topic == 'todo1'")
				ok(todoservice.tags.length == 0,"todoservice.tags.length == 0")
			})
		})

        test("delTodo *3*", function() {
			// Mock backend-service function 'delTodo' by hand
			// Return a response object with no data (only ok status)
			backend.delTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					resolve({
						statusText: "Ok",
					})
				})
			}
			// Now test the todo-service function 'delTodo' (it's a promise)
			expect(3)
			var newtodo1 = {
				topic: "todo1",
				done: false,
				id: 1
			}
			todoservice.addTodoObj(newtodo1)
			var newtodo2 = {
				topic: "todo2 #new",
				done: false,
				id: 2
			}
			todoservice.addTodoObj(newtodo2)
			return todoservice.delTodo(newtodo1).then(function() {
				ok(todoservice.todos.length == 1, "todoservice.todos.length == 1")
				ok(todoservice.todos[0].topic == 'todo2 #new', "todoservice.todos[0].topic == 'todo2 #new'")
				ok(todoservice.tags.length == 1,"todoservice.tags.length == 1")
			})
		})

        test("delTodo *4*", function() {
			// Mock backend-service function 'delTodo' by hand
			// Return a rejection
			backend.delTodo = function(todo) {
				return new Promise(function(resolve, reject) {
					reject()
				})
			}
			// Now test the todo-service function 'delTodo' (it's a promise)
			expect(3)
			var newtodo = {
				topic: "rappatapapp",
				done: false,
				id: 64
			}
			todoservice.addTodoObj(newtodo)
			return todoservice.delTodo(newtodo).catch(function(resp) {
				ok(resp.message != undefined, "response.message != undefined")
				ok(todoservice.todos.length == 1,"todoservice.todos.length == 1")
				ok(todoservice.tags.length == 0,"todoservice.tags.length == 0 (no change)")
			})
		})

	</script>

</body>

</html>
